---
layout: post
title: Virtual Machine to Machine feat. Windows
date: 2016-04-02 19:50:03
summary: How I migrated a VHD-based Windows 10 virtual machine to a physical partition.
categories: blog tech
---

My work requires me to use C# and ASP.NET MVC. This isn't a problem - I love C# and I think the ASP.NET MVC web framework is wonderful to work with. However, the .NET ecosystem, especially with regard to IDEs and MVC support, is lacking on every platform except Windows. Visual Studio is a very powerful and intuitive tool to work with, but the operating system limitation can be a bit of a pain sometimes.

I initially got around this by working from within a virtual machine. On my laptop, this worked quite well - it's certainly powerful enough to handle it, and it supports VT-x and VT-d so the processor doesn't run itself into overdrive (as well as supporting multi-core VMs which is super cool). However, it's not a great workflow to be constantly switching between Linux and Windows, especially on a single small display, and running a VM limits both your available RAM and your battery life.

However, I already had my workspace set up on Windows, within the virtual machine. I definitely didn't want to bother with re-installing everything again from scratch, and setting up licenses, and that mess. Hence, I thought... why not migrate my virtual machine to an actual physical partition? Surely it must be possible. I definitely couldn't imagine any *physical* limitation preventing me from doing so.

My laptop uses UEFI for booting. This process will likely be entirely different if you are not using UEFI and a GPT-based hard drive layout. This was quite a long process to do, and in hindsight, I saved absolutely no time whatsoever - however, it's quite a cool story to tell. Here are the steps I took to migrate my VHD-based Windows 10 virtual machine to a physical partition, and get it to boot.

# partition

To migrate your Windows installation to a physical partition, you need to make the partition first. This is easy enough to do; GParted offers a LiveCD (or LiveUSB) based distribution designed specifically for messing around with your partition table, and it's available [here](http://gparted.org/livecd.php). Put that onto a spare CD or a memory stick, boot into it (how you manage this depends on your own system) and fire up GParted.

Windows uses NTFS as its file system, so you're going to want to re-arrange your current partitions and make space for a Windows based partition. You're going to want a partition no less than 25 or 30 GB in size; I'm currently running my Windows installation in 42 GB of space with Visual Studio and other goodies installed, with about 15 GB to spare - and you really don't to have any less empty space lest you run into swapping or SSD performance issues.

GParted supports creation of NTFS partitions directly so I won't provide a step-by-step description of how to do this. However, while I'm at this point, I will mention that Windows, if installed the standard way, will create not one but up to four partitions on your disk. These are:

* **The EFI system partition**. If you're using a UEFI-based system you will already have this - it stores your bootloader, your Linux image, boot configuration files amongst other things. It's just a FAT32 partition that your motherboard firmware will initially boot into, and if you are dual-booting, will probably contain more than one bootloader. This is the only time you'll likely ever see Linux-related and Windows-related executables on the same partition co-existing; I have both `systemd-boot` and the Windows Boot Manager installed in my ESP.
* A *Microsoft Reserved* partition. I have no idea what this is or will be used for, and I think that Microsoft doesn't either. This doesn't seem to be used at all, and my laptop is running Windows fine without one. Don't bother trying to create this.
* A *recovery partition*. This contains a subset of WinRE (the Windows recovery environment) that you can also find on your installation media, and can come in handy if you need to repair your bootloader or fix a messed-up installation without digging out your install CD or burning an emergency ISO. You don't need this as such, and I don't know how to create one, but I thought I'd mention it for completeness.
* The actual Windows partition - this is your `C:\` drive.

Of these, you'll only need two. One of them, the EFI system partition, you won't need to create. However, take note of where it is on your disk. Usually (and as per the standard) this should be the first partition on your disk (partition 1). If it's not, note where it is *after you create the NTFS partition*. If it ends up being the third partition along, then it's partition 3. We can now move on to the next stage.

# copy

This part relies quite heavily on using a VHD for your virtual machine's hard drive. The procedure will likely work if you use a VMDK or whatever other formats VirtualBox supports or offers as default, but I can't guarantee the steps will be the same. I did this part on Arch - the way of acquiring the tools may differ if you use another Linux distribution. I'm not sure what the procedure is for this if your host OS is also Windows.

You'll want to acquire a tool called `vdfuse`. On Arch, this can be installed through the [`vdfuse` package in the AUR](https://aur.archlinux.org/packages/vdfuse/). On Ubuntu, I believe this is done by installing the `virtualbox-fuse` package. This allows you to mount a VHD file. You'll also need to install the `ntfs-3g` package to be able to mount your actual NTFS partition. You will probably want to be superuser for this section (eg. via `sudo su` or you'll be typing `sudo` a lot.

First, you'll want to mount the VHD itself. This can be done like this:

    mkdir /mnt/vhd
    vdfuse -w -f [path to VHD] /mnt/vhd

This will mount the virtual hard disk to `/mnt/vhd`. You're not done yet, however; inside `/mnt/vhd` is now a selection of files named `EntireDisk`, `Partition1`, `Partition2`, and so forth. In my case, there was only a `Partition1`, making it immediately obvious that this partition in the VHD contains Windows. Now, you'll need to mount this partition separately again.

    mkdir /mnt/vfs
    mount /mnt/vhd/Partition1 /mnt/vfs

With a bit of luck, you should now be able to see your virtual machine's Windows installation files inside `/mnt/vfs`. Now, we need to mount the partition we created earlier. This is simple enough. Find out the partition device name (eg. `/dev/sda3` - make sure you get this right or you'll mount the wrong thing) and do something like this.

    mkdir /mnt/part
    mount /dev/sda3 /mnt/part

Now the only remaining thing to do is literally copy all of your files from your virtual partition to the physical one. Don't forget to unmount everything afterward.

    cp -r /mnt/vfs/* /mnt/part
    umount /mnt/part
    umount /mnt/vfs
    umount /mnt/vhd

# WinRE

This next part can only be done through a proper Windows Recovery Environment, because we need to let Windows manage the recreation of the Windows Boot Manager and the other crap it pulls with it. Burn a Windows ISO to a flash drive (preferably the same Windows version as the one in your Virtual Machine), boot into it, and press Shift-F10. This should bring up a command line window. Now, recall from earlier where the EFI system partition was on your disk. You'll need this in a second.

**wip**
